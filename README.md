# Redis-ansible
## Общие сведения
Автоматическая развертка инфраструктуры для приложения Redis - Key-value

Только на кластер из 3х машин, состоящих из дистрибутивов: AlterOS, RedOS, Astra

Решение предлагает:
+ Развертывание базы данных Redi - Key-value на машине под управлением Astra
+ Развертывание сервера nginx с базовым шаблоном сайта на машине под управлением Astra
+ Базовые операции post и get для взаимодействия с базой данных через сервер nginx
+ Единственный вход в сеть через маршрутизатор под управлением AlterOS
+ Единственный доступ к серверу nginx с машины под управлением RedOS

Данный проект призван упростить развертку инфраструктуры под управлением вышеописанных систем, при этом оставляя возможность для дальнейшей модификации решения после развертки под свои нужды

Написано по казуальному через bash и ansible
## Скрипты базовой настройки машин
setup-alt.sh - скрипт настройки машины под управлением **AlterOS**.
+ Настраивает адаптер внутренней сети и адаптер выхода в интернет
+ Устанавливает и настраивает SSH (открытие порта 22, разрешение логина через root)
+ Включает пересылку пакетов
+ Настраивает и сохраняет правила iptables маскарадинга в crontab
+ Устанавливает git и ansible
+ Требует доступ в интернет

setup-redos.sh - скрипт настройки машины под управлением **RedOS**. 
+ Настраивает адаптер внутренней сети
+ Настраивает SSH (открытие порта 22, разрешение логина через root)
+ Указывает ip сервера nginx в */etc/hosts*
+ Не требует доступа в интернет

setup-astra.sh - скрипт настройки машины под управлением **Astra**.
+ Настраивает адаптер внутренней сети и создает файл *resolv.conf*
+ Устанавливает и настраивает SSH (открытие порта 22, разрешение логина через root)
+ Устанавливает пароль для пользователя root (ввод пользователя)
+ Требует предварительной настройки на AlterOS

Если вы считаете таковое необходимым и точно знаете, что делаете, можете изменить конфигурацию этих скриптов под свои нужды
## Скрипт настройки ssh
ssh-connection-alt.sh 
```
Тут че-то важное из кода и пояснения
```

## Ansible плейбук и files
ansible.cfg - тут какое-то краткое описание

inventory.ini - тут какое-то краткое описание

Папка *files* содержит копируемый конфиг на машину под управлением Astra, являющееся в данной конфигурации сервером nginx:
+ default
+ get.php
+ index.html
+ set.php

Файлы в данной папке могут быть модифицированы или заменены до запуска как в самой папке плейбука ansible, так и после на самой машине Astra

Более подробно об ansible.cfg
```
Тут че-то важное из кода и пояснения
```

## Порядок настройки
Независимо от того, использовали ли вы скрипты или вручную провели базовую настройку, пункт "Дальнейшая настройка" нужно выполнять в обоих случаях
### Ручная базовая настройка машин
В проекте представлены скрипты для базовой настройки машин, если по каким-либо причинам они вас не удовлетворяют, вы можете вручную настроить машины. В таком случае для дальнейшей работы необходимо иметь:
1. Настроенную ip адресацию всех хостах, а также resolv интернет имен
2. Установленный и настроенный SSH на всех хостах (открытый 22 порт, разрешение логина через root)
3. Как минимум один из хостов должен иметь доступ в интернет, через которую другие машины также смогуть выходить в него
4. Установленный пароль для пользователя root на Astra и других машинах
5. Установленный ansible на машину под управлением AlterOS
### Автоматизированная базовая настройка машин
**Важно:** перед запуском скрипта на Astra, необходимо сначала сделать базовую настройку машины, под управлением AlterOS, так как скрипт первой требует установки SSH и обновление компонентов системы.
#### Настройка AlterOS
1. Перенесите скрипт setup-alt.sh на машину под управлением AlterOS
2. В корневой директории введите следующую команду, чтобы сделать скрипт исполняемым:
```
chmod +x ./setup-alt.sh
```
3. Запустите скрипт, находясь в той же директории:
```
./setup-alt.sh
```
Убедитесь, что вы настроили AlterOS **перед** настройкой Astra

#### Настройка RedOS
1. Перенесите скрипт setup-redos.sh на машину под управлением RedOS
2. В корневой директории введите следующую команду, чтобы сделать скрипт исполняемым:
```
chmod +x ./setup-redos.sh
```
3. Запустите скрипт, находясь в той же директории:
```
./setup-redos.sh
```
В отличие от остальных машин не требует доступа в интернет

#### Настройка Astra
1. Перенесите скрипт setup-astra.sh на машину под управлением Astra
2. В корневой директории введите следующую команду, чтобы сделать скрипт исполняемым:
```
chmod +x ./setup-astra.sh
```
3. Запустите скрипт, находясь в той же директории:
```
./setup-astra.sh
```
Убедитесь, что **до** запуска скрипта вы настроили AlterOS, и что он дает доступ в интернет другим машинам

## Дальнейшая настройка
Скопируйте репозиторий на машину под управлением AlterOS:
```
git clone github.com/Striker32/Redis-ansible
```
Запустите скрипт ssh-connection-alt.sh, для копирования ключей на машины:
```
chmod +x ./ssh-connection-alt.sh
./ssh-connection-alt.sh
```
После запуска через непродолжительное время вас попросят ввести пароль от root пользователя на одной из машин, затем на следующей и на последней. Вводите пароли в соответствии с тем, в какую машину в данный момент вы копируете ключ (подсказка: **ИСПОЛЬЗУЙТЕ ГЛАЗА**)

Если копирование ключей прошло успешно, запустите плейбук ansible в той же директории:
```
ansible-playbook playbook.yml
```
## Завершение
После всех вышеописанных действий вам станет доступен сайт **только** на машине RedOS **только** по домену http://astra.redis/
